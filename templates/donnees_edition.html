{% extends 'base.html' %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">Données d'édition</h1>
    <form method="POST" class="mb-4">
        <div class="form-row align-items-center">
            <div class="col-auto">
                <label for="dateCreation">Date de création</label>
                <input type="date" class="form-control" id="dateCreation" name="dateCreation">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary mt-4">Rechercher</button>
            </div>
        </div>
    </form>

    <!-- Débogage -->
    <p class="text-center">Nombre de lots : {{ lots|length }}</p>

    <!-- Boutons pour télécharger les lots -->
    <div class="button-group">
        <a href="{{ url_for('telecharger_tous_les_lots') }}" class="btn btn-success">Télécharger tous les lots</a>
        <button class="btn btn-primary" onclick="telechargerSelection()">Télécharger les sélectionnés</button>
    </div>

    {% if lots %}
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Sélectionner</th>
                <th>Numéro du Lot</th>
                <th>Date de création</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for lot in lots %}
            <tr>
                <td><input type="checkbox" name="lot" value="{{ lot.id }}"></td>
                <td>{{ lot.numero }}</td>
                <td>{{ lot.date_creation.strftime('%Y-%m-%d') }}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="voirDetails('{{ lot.id }}')" title="Voir les détails">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="{{ url_for('telecharger_lot', lot_id=lot.id) }}" class="btn btn-sm btn-warning" title="Télécharger le lot">
                        <i class="fas fa-download"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center">Aucun lot trouvé.</p>
    {% endif %}
</div>

<!-- Modal pour afficher les détails du lot -->
<div id="detailModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Détails du Lot</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Contenu des détails du lot inséré ici via JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
    function voirDetails(lotId) {
        fetch(`/lot-details/${lotId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des détails du lot');
                }
                return response.json();
            })
            .then(data => {
                // Remplir le contenu de la modal avec les détails du lot
                let modalBody = document.querySelector('.modal-body');
                modalBody.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nom Édition</th>
                            <th>Type Édition</th>
                            <th>Type Envoi</th>
                            <th>Nombre Pages Destinataire</th>
                            <th>Nombre Destinataires</th>
                            <th>Nombre Pages</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.entries.map(entry => `
                            <tr>
                                <td>${entry.nom_edition}</td>
                                <td>${entry.type_edition}</td>
                                <td>${entry.type_envoie}</td>
                                <td>${entry.nombre_page_destinataire}</td>
                                <td>${entry.nombre_destinataires}</td>
                                <td>${entry.nombre_page}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

                // Afficher la modal
                $('#detailModal').modal('show');
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert(`Une erreur s'est produite lors de la récupération des détails du lot: ${error.message}`);
            });
    }

    function telechargerSelection() {
        const selectedLots = Array.from(document.querySelectorAll('input[name="lot"]:checked'))
            .map(checkbox => checkbox.value);

        if (selectedLots.length === 0) {
            alert('Veuillez sélectionner au moins un lot.');
            return;
        }

        fetch('/telecharger-lots-selectionnes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ lots: selectedLots }),
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Erreur lors du téléchargement des fichiers.');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lots_selectionnes.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur s\'est produite lors du téléchargement des fichiers.');
            });
    }
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dateDebut = document.getElementById('dateDebut').value;
        const dateFin = document.getElementById('dateFin').value;

        fetch('/rechercher-lots', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ dateDebut, dateFin }),
        })
            .then(response => response.json())
            .then(data => {
                // Mettre à jour le tableau avec les résultats de la recherche
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(lot => {
                    tbody.innerHTML += `
                <tr>
                    <td><input type="checkbox" name="lot" value="${lot.id}"></td>
                    <td>${lot.numero}</td>
                    <td>${new Date(lot.date_creation).toLocaleDateString()}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" onclick="voirDetails('${lot.id}')" title="Voir les détails">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="/telecharger-lot/${lot.id}" class="btn btn-sm btn-warning" title="Télécharger le lot">
                            <i class="fas fa-download"></i>
                        </a>
                    </td>
                </tr>
            `;
                });

                // Mettre à jour le compteur de lots
                document.querySelector('p.text-center').textContent = `Nombre de lots : ${data.length}`;
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur s\'est produite lors de la recherche des lots.');
            });
    });
</script>
{% endblock %}
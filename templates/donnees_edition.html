<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Données d'édition</title>
     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
     <!-- Font Awesome -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
     <!-- Custom CSS -->
     <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
     <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
 
     {% block head %}{% endblock %}
</head>
<!-- Contenu principal -->
<body>
<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar-fixed">
        <div class="sidebar-header">
            <img src="{{ url_for('static', filename='images/cnss-logo-2E8DFFBB2A-seeklogo.com.png') }}" alt="CNSS LOGO" class="img-fluid">
        </div>
        <ul class="list-unstyled components">
            <li>
                <a href="/"><i class="fas fa-home"></i> Accueil</a>
            </li>
            <li>
                <a href="#taskSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-tasks"></i> Tâches
                </a>
                <ul class="collapse list-unstyled" id="taskSubmenu">
                    <li>
                        <a href="{{ url_for('ajouter_lot') }}">Ajouter un nouveau Lot</a>
                    </li>
                    <li>
                        <a href="{{ url_for('donnees_edition') }}">Données d'édition</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="/rapport"><i class="fas fa-chart-bar"></i> Rapport</a>
            </li>
            <li>
                <a href="/settings"><i class="fas fa-cog"></i> Paramètres</a>
            </li>
        </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <main role="main" class="container-fluid">
            <div class="row">
                <div class="col-md-9 ml-sm-auto col-lg-10 px-4">
                    <div class="container mt-4">
                        <h1 class="mb-4">Données d'édition</h1>

                        <!-- Débogage -->
                        <p>Nombre de lots : {{ lots|length }}</p>

                        <!-- Boutons pour télécharger les lots -->
                        <a href="{{ url_for('telecharger_tous_les_lots') }}" class="btn btn-success">Télécharger tous les lots</a>
                        <button class="btn btn-primary" onclick="telechargerSelection()">Télécharger les sélectionnés</button>

                        {% if lots %}
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Sélectionner</th>
                                <th>Numéro du Lot</th>
                                <th>Date de création</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for lot in lots %}
                            <tr>
                                <td><input type="checkbox" name="lot" value="{{ lot.id }}"></td>
                                <td>{{ lot.numero }}</td>
                                <td>{{ lot.date_creation.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <!-- Utilisation de voirDetails() pour ouvrir la fenêtre modale -->
                                    <button type="button" class="btn btn-sm btn-primary" onclick="voirDetails('{{ lot.id }}')">Voir</button>
                                    <a href="{{ url_for('telecharger_lot', lot_id=lot.id) }}" class="btn btn-sm btn-warning">Télécharger</a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p>Aucun lot trouvé.</p>
                        {% endif %}
                    </div>

                    <!-- Modal pour afficher les détails du lot -->
                    <div id="detailModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="detailModalLabel">Détails du Lot</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <!-- Contenu des détails du lot inséré ici via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<!-- Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    function voirDetails(lotId) {
        fetch(`/lot-details/${lotId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la récupération des détails du lot');
            }
            return response.json();
        })
        .then(data => {
            // Remplir le contenu de la modal avec les détails du lot
            let modalBody = document.querySelector('.modal-body');
            modalBody.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nom Édition</th>
                            <th>Type Édition</th>
                            <th>Type Envoi</th>
                            <th>Nombre Pages Destinataire</th>
                            <th>Nombre Destinataires</th>
                            <th>Nombre Pages</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.entries.map(entry => `
                            <tr>
                                <td>${entry.nom_edition}</td>
                                <td>${entry.type_edition}</td>
                                <td>${entry.type_envoie}</td>
                                <td>${entry.nombre_page_destinataire}</td>
                                <td>${entry.nombre_destinataires}</td>
                                <td>${entry.nombre_page}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Afficher la modal
            $('#detailModal').modal('show');
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert(`Une erreur s'est produite lors de la récupération des détails du lot: ${error.message}`);
        });
    }

    function telechargerSelection() {
        const selectedLots = Array.from(document.querySelectorAll('input[name="lot"]:checked'))
                                  .map(checkbox => checkbox.value);

        if (selectedLots.length === 0) {
            alert('Veuillez sélectionner au moins un lot.');
            return;
        }

        fetch('/telecharger-lots-selectionnes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ lots: selectedLots }),
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Erreur lors du téléchargement des fichiers.');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lots_selectionnes.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur s\'est produite lors du téléchargement des fichiers.');
        });
    }

    $(document).ready(function () {
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar, #content').toggleClass('active');
        });
    });
</script>

</body>
</html>


